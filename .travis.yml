language: node_js
node_js:
- "0.12"
cache:
    directories:
    - node_modules
sudo: false
addons:
    postgresql: "9.4"
    apt:
        packages:
        - libcairo2-dev
        - libjpeg8-dev
        - libpango1.0-dev
        - libgif-dev
        - build-essential
        - g++
before_script: psql -c 'create database continua11y_test;' -U postgres
script: npm test --coverage
after_script:
- codeclimate-test-reporter < coverage/lcov.info
- ./scripts/continua11y.sh
notifications:
    email: false
env:
    global:
    - RUN_SCRIPT="1>/dev/null FRESHDB=TRUE forever start --spinSleepTime 5000 --minUptime 5000 app.js"
    - KILL_SCRIPT="1>/dev/null forever stop app.js"
    - USE_SITEMAP=false
    - PORT=3000
    - CONTINUA11Y="continua11y.18f.gov"
before_deploy:
- export PATH=$HOME:$PATH
- travis_retry curl -L -o $HOME/cf.tgz "https://cli.run.pivotal.io/stable?release=linux64-binary&version=6.15.0"
- tar xzvf $HOME/cf.tgz -C $HOME
- mkdir -p ${HOME}/Godeps/_workspace
- export GOPATH=${HOME}/Godeps/_workspace
- go get github.com/concourse/autopilot
- cf install-plugin -f $GOPATH/bin/autopilot
deploy:
- provider: script
  script: "./scripts/deploy.sh production"
  skip_cleanup: true
  on:
    branch: develop
    node: '0.12'
